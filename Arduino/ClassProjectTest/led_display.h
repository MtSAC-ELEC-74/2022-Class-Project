#include <SPI.h>

uint64_t LED_R = 0x100;
uint64_t LED_G = 0x010;
uint64_t LED_B = 0x001;

uint64_t MASK_LED = 0xffffffffffff;

uint64_t led_map [] = { 0b100100100100100100100100100100100100100000100000,
                        0b100100100100100100100100100100100100100000001000,
                        0b000100100100000000000000000000000000000000010000,
                        0b000000100100100000000000000000000000000000100000,
                        0b000000000100100100000000000000000000000000001000,
                        0b000000100100100000000000000000000000000000010000,
                        0b000100100100000000000000000000000000000000100000,
                        0b100100100100100100100100100100100100100000001000,
                        0b100100100100100100100100100100100100100000010000,
                        0b000000000000000000000000000000000000000000100000,
                        0b000000000000000000100100000000000000000000001000,
                        0b000000000000100100100100100100100100000000010000,
                        0b000000000000000000100100000000000100100000100000,
                        0b000000000000000000100100000000100100000000001000,
                        0b000000000000000000000000000000000000000000010000,
                        0b000000000000000000000000000000000000000000100000,
                        0b000100100100100000000000100100100100000000001000,
                        0b100100100100100100000000000100100100100000010000,
                        0b100100000000000100100000000000000100100000100000,
                        0b100100000000000000100100000000000100100000001000,
                        0b100100100100000000000100100100100100100000010000,
                        0b000100100100100000000000100100100100000000100000,
                        0b000000000000000000000000000000000000000000001000,
                        0b000000100100100100100100100100100100100000010000,
                        0b000100100100100100100100100100100100100000100000,
                        0b100100000000000100100000000000000000000000001000,
                        0b100100000000000100100000000000000000000000010000,
                        0b000100100100100100100100100100100100100000100000,
                        0b000000100100100100100100100100100100100000001000,
                        0b000000000000000000000000000000000000000000010000,
                        0b000100100100100100100100100100100100000000100000,
                        0b100100100100100100100100100100100100100000001000,
                        0b100100000000000000000000000000000100100000010000,
                        0b100100000000000000000000000000000100100000100000,
                        0b100100100100100000000000000100100100100000001000,
                        0b000100100100100000000000000100100100000000010000,
                        0b000000000000000000000000000000000000000000100000,
                        0b000001001001001000000000000001001001001000001000,
                        0b001001001001001000000000001001001001001000010000,
                        0b001001000000000000001001001001000001001000100000,
                        0b001001000000001001001001000000000001001000001000,
                        0b001001001001001001000000000000000001001000010000,
                        0b000001001001001000000000000000000001001000100000,
                        0b000000000000000000000000000000000000000000001000,
                        0b000001001001001001001001001001001001000000010000,
                        0b001001001001001001001001001001001001001000100000,
                        0b001001000000000000000000000000000001001000001000,
                        0b001001000000000000000000000000000001001000010000,
                        0b001001001001001001001001001001001001001000100000,
                        0b000001001001001001001001001001001001000000001000,
                        0b000000000000000000000000000000000000000000010000,
                        0b000001001001001000000000000001001001001000100000,
                        0b001001001001001000000000001001001001001000001000,
                        0b001001000000000000001001001001000001001000010000,
                        0b001001000000001001001001000000000001001000100000,
                        0b001001001001001001000000000000000001001000001000,
                        0b000001001001001000000000000000000001001000010000,
                        0b000000000000000000000000000000000000000000100000,
                        0b000001001001001000000000000001001001001000001000,
                        0b001001001001001000000000001001001001001000010000,
                        0b001001000000000000001001001001000001001000100000,
                        0b001001000000001001001001000000000001001000001000,
                        0b001001001001001001000000000000000001001000010000,
                        0b000001001001001000000000000000000001001000100000,
                      };

class LED_Display
{
    uint8_t led_cs;
    uint8_t oe;
  public:
    uint64_t led_value = 0;
    LED_Display(uint8_t cs, uint8_t oe)
    {
      pinMode(oe, OUTPUT);
      digitalWrite(oe, LOW);
      pinMode(cs, OUTPUT);
      led_cs = cs;
      SPI.begin();
      SPI.setClockDivider(SPI_CLOCK_DIV4);
      SPI.setDataMode(SPI_MODE2);
    }

    void led_out(uint64_t value)
    {
      char s[100];
      //sprintf(s, "%PRIx64", value);
      //Serial.println(s);
      digitalWrite(led_cs, LOW);
      delayMicroseconds(10);
      SPI.transfer((uint8_t)( (value >>  40) & 0xff ));
      SPI.transfer((uint8_t)( (value >>  32) & 0xff ));
      SPI.transfer((uint8_t)( (value >>  24) & 0xff ));
      SPI.transfer((uint8_t)( (value >>  16) & 0xff ));
      SPI.transfer((uint8_t)( (value >>  8) & 0xff ));
      SPI.transfer((uint8_t)( (value >>  0) & 0xff ));
      delayMicroseconds(10);
      digitalWrite(led_cs, HIGH);
    }

    uint8_t led_control( char* command )
    {
      if ( strncmp( command, "led.", 4 ) == 0 ) {
        char *sub_command;
        sub_command = &command[4];

        if ( strcmp( sub_command, "off" ) == 0 ) {
          digitalWrite(oe, LOW);
        }
        else if ( strcmp( sub_command, "on" ) == 0 ) {
          digitalWrite(oe, HIGH);
        }
        else if ( strcmp( sub_command, "inc" ) == 0 ) {
          if ( led_value > MASK_LED || led_value == 0 )
            led_value = 1;
          else
            led_value = led_value << 1;
          led_out( led_value );
        }
        else if ( strcmp( sub_command, "map" ) == 0 ) {
          led_value = (led_value + 1) % (sizeof(led_map) / 8);
          led_out( led_map[led_value] );
        }
        else if ( strcmp( sub_command, "display" ) == 0 ) {
          while (Serial.available() == 0)
          {
            led_value = (led_value + 1) % (sizeof(led_map) / 8);
            led_out( led_map[led_value] );
            delayMicroseconds(1000);
          }
        }
        else
        {
          return 0; //return false if lcd command not found
        }
        return 1; //return true if lcd command and found
      }
      else
        return 0; //return false if not lcd command
    }
    void bar_off()
    {
      led_out( 0b000000000000000000000000000000000000000000000000 );
    }
    void bar_red()
    {
      led_out( 0b100100100100100100100100100100100100100100100100 );
    }
    void bar_blue()
    {
      led_out( 0b001001001001001001001001001001001001001001001001 );
    }
    void bar_green()
    {
      led_out( 0b010010010010010010010010010010010010010010010010 );
    }
    uint64_t dot_color(uint64_t color, uint64_t pos)
    {
      if (pos > 15) pos = 15;
      return ((uint64_t)color) << (pos * (uint64_t)3);
    }
    void dot_red(uint64_t pos)
    {
      uint64_t color = dot_color(LED_R, pos);
      led_out( color );
    }
    void dot_blue(uint64_t pos)
    {
      uint64_t color = dot_color(LED_G, pos);
      led_out( color );
    }
    void dot_green(uint64_t pos)
    {
      uint64_t color = dot_color(LED_B, pos);
      led_out( color );
    }
};
